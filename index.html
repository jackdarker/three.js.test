<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
    <p>there should be an object visible</p>
	<button id="animation.walk">hands up</button>
	<button id="animation.jump">hands down</button>
	<button id="noarm">toggle arm</button>
	<button id="expres">change expression</button>
	<button id="cam">change view</button>
    <p id="canvas" style='height:100%; width: 100%;'></p>
    	<!--script src="src/three.min.js"></script-->
		<script type="importmap">
			{
			  "imports": {
				"three": "./node_modules/three/build/three.module.js"
			  }
			}
		  </script>
		<script type="module">
		import * as THREE from './node_modules/three/build/three.module.js';
		import Stats from './node_modules/three/examples/jsm/libs/stats.module.js';
		import { GUI } from './node_modules/three/examples/jsm/libs/lil-gui.module.min.js';
		import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js';
		import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
		import { RGBELoader } from './node_modules/three/examples/jsm/loaders/RGBELoader.js';
		import { FBXLoader } from './node_modules/three/examples/jsm//loaders/FBXLoader.js';
		window.gm = window.gm || {};
		window.gm.showScene=function(){
			
		}
		let stats, clock, gui,mesh,clips, mixer, actions, activeAction, previousAction;
		let camera, scene, renderer, model,arm, face,expressions;
		const api = { state: 'Idle' };

		scene = new THREE.Scene();
		camera = new THREE.PerspectiveCamera( 75, 400/400, 0.01, 1000 );
		clock = new THREE.Clock();
		renderer = new THREE.WebGLRenderer({ antialias: true });
      	const canvas = document.getElementById('canvas')

			//renderer.setSize( window.innerWidth, window.innerHeight );
			//document.body.appendChild( renderer.domElement );
		renderer.setSize(400,400 );//canvas.innerWidth, canvas.innerHeight );
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.outputEncoding = THREE.sRGBEncoding;
		canvas.appendChild( renderer.domElement );
		//stats = new Stats();canvas.appendChild( stats.dom ); //FPS

		const controls = new OrbitControls( camera, canvas );
		controls.target.set( 0, 0.5, 0 );
		controls.update();
		controls.enablePan = true;
		controls.enableDamping = true;

		scene.background = new THREE.Color( 0xe0e0e0 );
		scene.fog = new THREE.Fog( 0xe0e0e0, 20, 100 );
		const geometry = new THREE.BoxGeometry( 1, 1, 1 );
		const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
		const cube = new THREE.Mesh( geometry, material );
		scene.add( cube );
		cube.position.set(-3,0,0)

		//lights
		const hemiLight = new THREE.HemisphereLight( 0xffffff, 0x444444 );
		hemiLight.position.set( 0, 20, 0 );
		scene.add( hemiLight );
		const dirLight = new THREE.DirectionalLight( 0xffffff );
		dirLight.position.set( 0, 20, 10 );
		scene.add( dirLight );

		//adjust camera
		camera.position.z = 2,camera.position.y = 1;

		//loading model
		if(true){
		const loader = new GLTFLoader();
		loader.load(
			//"dude/RobotExpressive.glb"
			"dude/calaviper2.glb" 
			//'dude/kyoukaeevee_b.glb'
			//'dude/dude1.gltf'
		, function ( object ) {
			mesh=object.scene;
			mixer = new THREE.AnimationMixer( mesh );
			//clips = object.animations;
			createGUI( object.scene,object.animations );
			mesh.traverse( function ( child ) {
				console.log(child);
				if(child.name==="arm_lower_right"||child.name==="skirt") {
					arm = child;
				}
				} );
				face = mesh.getObjectByName( 'Head_4' );
				if(face)expressions = Object.keys( face.morphTargetDictionary );
			scene.add( mesh );
			//mesh.rotation.y=Math.PI;
			mixer.addEventListener( 'loop', function( e ) {console.log(e); // properties of e: type, action and loopDelta
				e.action.paused=true; //stop looping action
			} ); //looping anims dont fire finished
			//mixer.addEventListener( 'finished', function( e ) { console.log(e);e.action.paused=true;} ); // properties of e: type, action and direction
			//togglePose("animation.walk")
		//animate(); //if no requestAnimationFrame
			}, undefined, function ( e ) {console.error( e );	} );
		}else{
		//////////////////  FBX   //////////////////////////////
			const loader = new FBXLoader();
			loader.load('dude/calaviper1.fbx'
				//'dude/kyoukaeevee_b.fbx' 
				//'cougar/Enuleth.fbx'
			//Samba Dancing.fbx
			,function ( object ) {
				mixer = new THREE.AnimationMixer( object );
				//actions = object.animations;
				object.traverse( function ( child ) {
					if ( child.isMesh ) {
							child.castShadow = true;
							child.receiveShadow = true;
						}
				} );
				scene.add( object );
				object.scale.set(0.002,0.002,0.002)
			}, undefined, function ( e ) {console.error( e );	} );
		}

		function createGUI( model, animations ) {
			const states = [ 'Idle', 'Walking', 'Running',  'Death', 'Sitting', 'Standing' ];
			const emotes = [ 'Jump', 'Yes', 'No', 'Wave', 'Dance','Punch', 'ThumbsUp' ];

			gui = new GUI();
			actions = {};
			for ( let i = 0; i < animations.length; i ++ ) {
				const clip = animations[ i ];
				const action = mixer.clipAction( clip );
				actions[ clip.name ] = action;
				if ( emotes.indexOf( clip.name ) >= 0 || states.indexOf( clip.name ) >= 4 ) {
					action.clampWhenFinished = true;
					action.loop = THREE.LoopOnce;
				}
			}

			// states
			const statesFolder = gui.addFolder( 'States' );
			const clipCtrl = statesFolder.add( api, 'state' ).options( states );
			clipCtrl.onChange( function () {
				fadeToAction( api.state, 0.5 );
			} );
			statesFolder.open();

			// emotes
			const emoteFolder = gui.addFolder( 'Emotes' );
			////
			function createEmoteCallback( name ) {
				api[ name ] = function () {
					fadeToAction( name, 0.2 );
					mixer.addEventListener( 'finished', restoreState );
				};
				emoteFolder.add( api, name );
			}
			////
			function restoreState() {
				mixer.removeEventListener( 'finished', restoreState );
				//fadeToAction( api.state, 0.2 );
			}

			for ( let i = 0; i < emotes.length; i ++ ) {
				createEmoteCallback( emotes[ i ] );
			}
			emoteFolder.open();

			// expressions
			model.traverse( function ( child ) {
				if(!face && child.morphTargetDictionary){
					face=child;
				}
			});
			face = face || model.getObjectByName( 'Head_4' );
			const expressions = Object.keys( face.morphTargetDictionary );
			const expressionFolder = gui.addFolder( 'Expressions' );

			for ( let i = 0; i < expressions.length; i ++ ) {
				expressionFolder.add( face.morphTargetInfluences, i, 0, 1, 0.01 ).name( expressions[ i ] );
			}
			activeAction = actions[ 'Idle' ];
			activeAction.play();
			expressionFolder.open();
		}
		function fadeToAction( name, duration ) {
			previousAction = activeAction;
			activeAction = actions[ name ];
			if ( previousAction !== activeAction ) {
				previousAction.fadeOut( duration );
			}
			//mixer.stopAllAction(); 
			activeAction
				//.setLoop(THREE.LoopOnce,1) doesnt work as expected? anim gets jumpy
				.reset()
				.setEffectiveTimeScale( 1 )
				.setEffectiveWeight( 1 )
				.fadeIn( duration )
				.play();
		}
		function togglePose(pose){
			// Play a specific animation
			const clip = THREE.AnimationClip.findByName( actions, pose );
			if(!clip) return;
			//mixer.stopAllAction(); if already running an action
			const action = mixer.clipAction( clip );
			action.reset()
				.setEffectiveTimeScale( 1 )
				.setEffectiveWeight( 1 )
				//.setDuration(0)
				//.fadeIn( 0.2 )
				.play();
		}
		function toggleVisibility(){
			arm.visible=!arm.visible;
		}
		function toggleCam(){
			if(camera.position.x===0) {
				camera.position.x=1
			}else {
				camera.position.x=0;
			}
			camera.lookAt(new THREE.Vector3(0,2,0));
		}
		function toggleExpression() {
			if(face.morphTargetInfluences[0]!==0) {
				face.morphTargetInfluences[0]=0.0;
			} else face.morphTargetInfluences[0]=1.0
		}
		function animate() {
			const dt = clock.getDelta();
			cube.rotation.x += 0.01;
			cube.rotation.y += 0.01;
			renderer.render( scene, camera );
			if(mixer) mixer.update( dt );
			controls.update();
			requestAnimationFrame( animate );
		};
		animate();
		document.getElementById('animation.walk').addEventListener('click', function(){togglePose('Walking');});
		document.getElementById('animation.jump').addEventListener('click', function(){togglePose('Jump');});
		document.getElementById('noarm').addEventListener('click', function(){toggleVisibility();});
		document.getElementById('cam').addEventListener('click', function(){toggleCam();});
		document.getElementById('expres').addEventListener('click', function(){toggleExpression();});
		</script>
	</body>
</html>